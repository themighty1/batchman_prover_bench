#!/bin/bash
#
# Batchman PROVER Benchmark
# Runs prover and verifier locally, reports prover stats:
#   - Total runtime
#   - VOLEs consumed
#   - Bytes sent/received
#

DIR="$(cd "$(dirname "$0")" && pwd)"
PROVER="$DIR/build/bin/test_bench_batchman_prover"
VERIFIER="$DIR/build/bin/test_bench_batchman_verifier"

# Show help if no arguments
if [ $# -eq 0 ]; then
    echo "Batchman PROVER Benchmark"
    echo ""
    echo "Usage: ./run <DIM> <BRANCHES> <BATCHES>"
    echo "       ./run build"
    echo ""
    echo "Commands:"
    echo "  build      Build/rebuild the benchmark binaries"
    echo ""
    echo "Arguments:"
    echo "  DIM        Matrix dimension (computation = DIM^3 multiplications per branch)"
    echo "  BRANCHES   Number of branches in disjunction (B)"
    echo "  BATCHES    Number of batch instances to prove (R)"
    echo ""
    echo "Examples:"
    echo "  ./run build            # build first"
    echo "  ./run 3 20 1000        # dim=3 (27 muls), 20 branches, 1000 batches"
    echo "  ./run 6 100 2000       # dim=6 (216 muls), 100 branches, 2000 batches"
    echo ""
    echo "Protocol complexity:"
    echo "  VOLEs = R × (4×DIM² + 5×DIM³ + 1)"
    echo "  Bytes = 8 × R × (4×DIM² + 6×DIM³ + B + 2)"
    exit 0
fi

# Build command
if [ "$1" == "build" ]; then
    echo "Building batchman benchmark..."
    cd "$DIR/build" && make -j4 test_bench_batchman_prover test_bench_batchman_verifier
    exit $?
fi

# Check binaries exist
if [ ! -f "$PROVER" ] || [ ! -f "$VERIFIER" ]; then
    echo "Error: Binaries not found. Run './run build' first."
    exit 1
fi

PORT=12345
DIM=$1
BRANCHES=$2
BATCHES=$3

# Run verifier in background (silent), then prover in foreground
($VERIFIER $PORT 127.0.0.1 $DIM $BRANCHES $BATCHES > /dev/null 2>&1) &
sleep 0.1
$PROVER $PORT $DIM $BRANCHES $BATCHES
